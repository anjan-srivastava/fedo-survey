'use strict';

(function() {
    
    var rootEl = document.getElementById('outreech-carousel'),
        parentEl;
    if (!rootEl ) parentEl = document.body;
    else parentEl = rootEl.parentNode;
    if (parentEl == document.head) parentEl = document.body;

   var clientWidth = window.document.documentElement.clientWidth,
       IS_MOBILE = clientWidth <= 489,
       PLUGIN_WIDTH = '100%',
       WIDGET_PAD = IS_MOBILE?{ x: 0, y: 0}: {x:5, y: 15},
       MAX_RATING = 5,
       perPageSlide = 2,
       init; // actual content loader

    var reviews = #{reviews}, /***** part of template ****/
        config = #{config}; 

    // defines context for iframe container
    // NOTE! this function morphs document and window property
    init = function (document, window) {
     
                        
                    /**
         * returns wrapper around HTMLNode
         * @param selector a css selector string
         *        ; for now only class selector is implemented
         *
         * TODO for now parsing/checks are not implemented.
         */

        /*==== start: utilities ===*/
        var onode = function (selector) {
            var _Onode;

            // internal class implementation
            _Onode = function() {
                this.domNode = null;
                this.render(selector);
            };

            // returns ONode object
            _Onode.prototype.render = function(selector) {
                var parts = selector.split('.'),
                    node = document.createElement(parts[0]);
                    
                parts.slice(1).forEach(function(cl) {
                    node.className += cl + " ";
                });

                this.domNode = node;
                return this; 
            };
            
            // appends given _Onode.domNode as child node of this _Onode.domNode
            _Onode.prototype.append = function(selectors) {
                if (this.domNode != null) {
                    if (typeof selectors.render === "function") {
                        this.domNode.appendChild(selectors.domNode); 
                    } else {
                        if (typeof selectors === "string") selectors = [selectors];
                        for (var i=0;i<selectors.length;i+=1) {
                            var selector = selectors[i],
                                aNode = onode(selector);
                            this.domNode.appendChild(aNode.domNode);
                        }
                    }
                }

                return this;
            };


            // adds inner text to domNode
            _Onode.prototype.text = function(t) {
                this.domNode.appendChild(document.createTextNode(t));
                return this;
            };

            _Onode.prototype.attr = function(key, value) {
                if (this.domNode != null) {
                    this.domNode[key] = value;
                }

                return this;
            };


            return new _Onode();
        };

        /*==== end: utilities ===*/

        /*==== start: renderers ===*/
        
        var mainCont = document
            .getElementById('outreech-carousel-container');

        var renderReview,
            renderWidget,
            setupActions,
            setupStyles;

        
        renderReview = function(model) {
            var renderRating,
                renderTitle,
                renderCardHead,
                renderCardContent,
                renderCard;

           
            // returns ONode for rating
            renderRating = function() {
                var rating = parseInt(model.rating),
                    nd = onode('div'),
                    stars = [],
                    i;

                for (i=0;i<rating;i+=1) stars.push('i.fa.fa-star.filled');
                for (i=rating;i<MAX_RATING;i+=1) stars.push('i.fa.fa-star.empty');

                return nd.append(stars);
            };

            renderTitle = function() {
                return onode('div.title.clearfix').append(renderRating());
            };

            renderCardHead = function() {
                var reviewDate = onode('div.extra').text(model.date);
                if (!config.settings.showReviewDate) reviewDate.attr('style', 'display:none');
                return onode('h5')
                       .append(renderTitle());
                       //.append(reviewDate);
            };

            renderCardContent = function() {
                var rt = onode('p');
                if (model.content.media &&
                        model.content.media.length) {
                    rt.append(onode('img').attr('src', model.content.media[0]));
                }

                if (model.content.text && model.content.text.length)
                    rt.append(onode('q').text(model.content.text));


                

                return rt;
            };


            renderCard = function() {
                var card = onode('div.orw-card');
       
                var nameNode = onode('div').text(model.user.name);
                if (!config.settings.showReviewerName) nameNode.attr('style', 'display:none');

                nameNode.domNode.style.color = config.design.nameFontColor;

                return card.append(renderCardHead())
                        .append(renderCardContent())
                        .append(onode('h5.username.clearfix').append(nameNode));
            };



            var cardWrapper = onode('div.orw-card-w');
            return cardWrapper.append(renderCard());
        };



        renderWidget = function(reviews) {
            var titleBar = onode('div.widget-title.clearfix'),
                slider = onode('div.siema.owl-carousel'),
                i, rt, pagxn, cnt;

             // !IS_MOBILE && (slider.domNode.style.margin = '0 25px'); // important for widget to display properly

            titleBar.attr('style', 'color: ' + config.design.titleFontColor);
            if (config.settings.titleEnabled) {
                titleBar.append(onode('span').text(config.settings.titleText).attr('style','color: ' + config.design.titleFontColor));
                
            }
            
            var rating = function() {
                    var total = 0.0;
                    for (var i=0;i<reviews.length;i+=1) {
                        total += window.parseFloat(reviews[i].rating);
                    };

                    if (reviews.length) total = total / reviews.length;
                   
                    if (total > window.parseInt(total)) total = (window.parseInt(total) + .5);
                    return total.toFixed(1);
                }() ,
                renderRatingFrac = function(fracRating) { 
                    var rating = window.parseInt(fracRating),
                        nd = onode('span').attr('style', 'margin: 0 5px'),
                        stars = [],
                        i;

                    for (i=0;i<rating;i+=1) stars.push('i.fa.fa-star.filled');
                    if (fracRating > rating) stars.push('i.fa.fa-star-half.filled');
                    for (i=rating;i<MAX_RATING;i+=1) stars.push('i.fa.fa-star.empty');

                    return nd.append(stars);
            };


            var avgRatingVisibility = 'visible';
            if (!config.settings.avgRatingEnabled) {
                avgRatingVisibility = 'hidden';
            }
            
            titleBar.append(onode('div.summary').attr('style', 'visibility:' + avgRatingVisibility)
                            .append(onode('span.rating').text(rating))
                            .append(renderRatingFrac(rating))
                            .append(onode('span.extra').text('based on ' + reviews.length + ' reviews')));

            for(i=0;reviews && (i<reviews.length);i+=1)
                slider.append(renderReview(reviews[i]));

            cnt = onode('div.content').attr('style', 'background:' + config.design.backgroundColorCarousel)
                                .append(titleBar)
                                .append(onode('div')
                                    .append(onode('div.action.left.ic-chevron-left'))
                                    .append(slider)
                                    .append(onode('div.action.right.ic-chevron-right'))
                                    //.append(pagxn)
                                )
                                .append(onode('div.poweredByText')
                                        .append(onode('span')
                                                .append('i.fa.fa-bolt')
                                                .append(onode('a').attr('href', 'http://outreech.io').attr('target', 'blank').text('by OutReech'))));

            rt = onode('div')
                    .append(cnt);

            if (!(reviews && reviews.length && config.settings.enabled)) {
                rt.attr('style', 'display:none;');
            }

            return rt;
        };

        /*==== end: renderers ===*/


        setupActions = function(widgetNode) {
            // load slider script
            widgetNode.append(onode('script').attr('src', '#{staticUrl}/owl.carousel.min.js').attr('onload', function() {
                var currentSlide = 0,
                    lastSlideIndex = (document.getElementsByClassName('orw-card').length - perPageSlide + 1) - 1,
                    autoHeight = function() {
                        var z = window.getComputedStyle(mainCont).height;
                        window.setTimeout(function() { iframe.style.height = z; }, 0);
                    };

                var owl = window.jQuery('.siema')

                owl.on('initialized.owl.carousel', 
                        function() { 
                            autoHeight(); 
                            mainCont.style.visibility = 'visible';
                        });

                owl.on('resized.owl.carousel', autoHeight);

                owl.owlCarousel({
                    loop:true,
                    margin: 10,
                    responsiveClass: true,
                    //autoplay: config.settings.scrollEnabled,
                    autoplayHoverPause: true,
                    responsive:{
                        0:{
                            items:1,
                            autoplay: config.settings.scrollEnabled && (reviews.length > 1)
                        },

                        655:{
                            items:2,
                            autoplay: config.settings.scrollEnabled && (reviews.length > 2)
                        },
                        1100:{
                            items:3,
                            autoplay: config.settings.scrollEnabled && (reviews.length > 3)
                        }
                    }
                });


                document.getElementsByClassName('action left')[0]
                    .addEventListener('click', function(e) { owl.trigger('prev.owl.carousel'); }, false);

                document.getElementsByClassName('action right')[0]
                    .addEventListener('click', function(e) { owl.trigger('next.owl.carousel') }, false);
                
                var isOpen, 
                    content = widgetNode.domNode.getElementsByClassName('content')[0],

                    calcClipClosed = function () {
                        var s = window.getComputedStyle(iframe),
                            w = window.parseInt(s.width), h = window.parseInt(s.height),
                            f = {w: 76, h: 76 },
                            clip = {t: (h - f.h), r: f.w, b:h, l:0};

                        if (config.settings.position) {
                            clip.r = w;
                            clip.l = w - f.w;                                   
                        } 
                        var t = 'rect(' + clip.t + 'px ' + clip.r + 'px ' + clip.b + 'px ' + clip.l + 'px)';   
                        console.log(t);
                        return t;
                    };

                isOpen = true;

            }));

            

        };

        setupStyles = function() {
            document.head.appendChild(
                onode('link')
                .attr('rel', 'stylesheet')        
                .attr('href', 'https://fonts.googleapis.com/css?family=Roboto:100,300,400,500')
                .domNode
            ); 
            document.head.appendChild(
                onode('link')
                .attr('rel', 'stylesheet')        
                .attr('href', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css')
                .domNode
            ); 
            
            document.head.appendChild(
                onode('link')
                .attr('rel', 'stylesheet')        
                .attr('href', '#{staticUrl}/carousel.css')
                .domNode
            ); 
            
            document.head.appendChild(
                onode('link')
                .attr('rel', 'stylesheet')        
                .attr('href', '#{staticUrl}/assets/owl.carousel.min.css')
                .domNode
            ); 


            // apply customization changes by user
            // 1. background color
            Array.from(document.getElementsByClassName('orw-card')).forEach(function(elem) {
                elem.style.backgroundColor = config.design.backgroundColorOpen;
            });
            // 2. Font color
            Array.from(document.getElementsByTagName('q')).filter(function(el) { return !el.previousSibling; }).forEach(function (elem) {
                elem.style.color = config.design.fontColor;
            });
            // 3. Rating Icon color
            Array.from(document.getElementsByClassName('fa-star filled')).forEach(function (elem) {
                elem.style.color = config.design.ratingIconColor;
            });
        };  

        // render and mount widget
        var widget = renderWidget(reviews);
        try {

            mainCont.style.visibility = 'hidden';
            mainCont.style.width = PLUGIN_WIDTH; // this is important for slider to work correctly.
            mainCont.appendChild(widget.domNode);
        } catch (e) { /*ignore*/ }

        // load styles
        setupStyles();

        widget.append(onode('script').attr('src', 'https://code.jquery.com/jquery-3.3.1.min.js')
        .attr('onload', function() {
            setupActions(widget);
        }));
        
    }; //************* `init` context ends here ************
 

    
    // setup every thing in iframe
    var iframe = document.createElement('iframe');
    iframe.width = PLUGIN_WIDTH;
    iframe.height = 332;
    iframe.src = 'about:blank';
    iframe.style = 'border:none;overflow:hidden;z-index:9999';

  /*
    iframe.style.bottom = WIDGET_PAD.y + 'px';
    // Positioning of widget  
    if (config.settings.position) { //right
        iframe.style.right = WIDGET_PAD.x + 'px';
    } else {
        iframe.style.left = WIDGET_PAD.x + 'px';
    }
 */

    iframe.onload = function() {
        var iframeWindow = iframe.contentWindow, iframeDoc = iframeWindow.document,
            cls = IS_MOBILE?"class='mobile'":"";

        iframeDoc.open();
        iframeDoc.write("<html><body "+ cls +"style='overflow:hidden'><div id='outreech-carousel-container'></div></body></html>");
        iframeDoc.close();

        init(iframeDoc, iframeWindow);

        // only now append to parent dom
    };

    if (!reviews || !reviews.length || !config.settings.enabled) iframe.style.display = 'none';   
    //document.body.appendChild(iframe);
    
    

    parentEl.appendChild(iframe);

}());

